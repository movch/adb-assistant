name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Build app
        run: |
          set -eo pipefail
          xcodebuild \
            -scheme "ADB Assistant" \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            archive \
            -archivePath "$PWD/build/ADB Assistant.xcarchive"

      - name: Package app bundle
        run: |
          set -eo pipefail
          ARCHIVE_PATH="$PWD/build/ADB Assistant.xcarchive"
          PRODUCT_PATH="$ARCHIVE_PATH/Products/Applications/ADB Assistant.app"
          DEST_DIR="$PWD/release"
          mkdir -p "$DEST_DIR"
          ditto -c -k --keepParent "$PRODUCT_PATH" "$DEST_DIR/ADB_Assistant.app.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/ADB_Assistant.app.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
